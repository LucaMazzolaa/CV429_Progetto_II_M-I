<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS TRACKER - FULL ACTIVE SATELLITE FLEET</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --fg-color: #ffffff;
            --border-width: 2px;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background-color: var(--bg-color); font-family: monospace; color: var(--fg-color);
            overflow: hidden;
        }

        ::selection { background: var(--fg-color); color: var(--bg-color); }

        #main-container { position: relative; width: 100vw; height: 100vh; }

        #hud-container {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: var(--bg-color); padding: 15px;
            border: var(--border-width) solid var(--fg-color); box-sizing: border-box; z-index: 1000;
        }

        h1 {
            margin: 0 0 15px 0; font-size: 1rem; text-transform: uppercase;
            letter-spacing: 1px; padding-bottom: 8px; border-bottom: var(--border-width) solid var(--fg-color);
            display: flex; align-items: center;
        }

        .data-row {
            display: flex; justify-content: space-between; margin: 10px 0;
            font-size: 0.9rem; border-bottom: 1px dotted #444; padding-bottom: 3px;
        }

        .label { color: #aaaaaa; }
        .value { font-weight: bold; color: var(--fg-color); }

        #status-indicator {
            display: inline-block; width: 8px; height: 8px;
            background-color: var(--fg-color); margin-right: 10px; animation: blink 1.5s step-end infinite;
        }

        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        .btn-brutal {
            width: 100%; background-color: var(--bg-color); color: var(--fg-color);
            border: var(--border-width) solid var(--fg-color); padding: 8px; margin-top: 10px;
            font-family: monospace; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-transform: uppercase;
        }
        .btn-brutal:hover { background-color: var(--fg-color); color: var(--bg-color); }

        .footer {
            margin-top: 15px; font-size: 0.7rem; text-align: right;
            border-top: var(--border-width) solid var(--fg-color); padding-top: 8px; text-transform: uppercase;
        }

        #map-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        #map { width: 100%; height: 100%; background-color: var(--bg-color); }

        #globe-container {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 2;
            display: none; background-color: var(--bg-color);
        }

        .map-base-layer, .map-label-layer { filter: invert(100%) grayscale(100%) brightness(180%) contrast(180%); }

        .leaflet-control-zoom { border: var(--border-width) solid var(--fg-color) !important; border-radius: 0 !important; }
        .leaflet-control-zoom a { background-color: var(--bg-color) !important; color: var(--fg-color) !important; border-radius: 0 !important; }

        .iss-marker-custom { display: flex; align-items: center; justify-content: center; position: relative; }
        .iss-marker-shape {
            width: 16px; height: 16px; background-color: var(--bg-color); border: var(--border-width) solid var(--fg-color); position: relative;
        }
        .iss-marker-shape::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 4px; height: 4px; background-color: var(--fg-color);
        }
        
        .iss-label-2d {
            position: absolute; left: 22px; color: var(--fg-color);
            font-family: monospace; font-weight: bold; font-size: 14px; pointer-events: none;
        }

        #help-text-3d { position: absolute; bottom: 20px; left: 20px; z-index: 1000; font-size: 0.8rem; color: #888; pointer-events: none; display: none; }
        .alert-status { font-size: 0.65rem; color: #ff5555; margin-top: 5px; display: none; }

        /* Mantiene nascosto il vecchio pulsante */
        #btn-load-sats { display: none !important; }

        /* Stile per il quadratino del satellite JSON */
        .sat-marker-square {
            width: 3px;
            height: 3px;
            background-color: #00ffff; /* Azzurro Ciano HUD */
            border: none;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="map-container"><div id="map"></div></div>
        <div id="globe-container"></div>

        <div id="hud-container">
            <h1><span id="status-indicator"></span>SYSTEM ACTIVE</h1>
            <div class="data-row"><span class="label">TARGET:</span><span class="value">ISS (ZARYA)</span></div>
            <div class="data-row"><span class="label">LAT:</span><span class="value" id="lat">SCANNING</span></div>
            <div class="data-row"><span class="label">LON:</span><span class="value" id="lon">SCANNING</span></div>
            <div class="data-row"><span class="label">T-STAMP:</span><span class="value" id="time">--:--:--</span></div>
            
            <button id="btn-3d-toggle" class="btn-brutal">ENABLE 3D MODE</button>
            
            <button id="btn-load-sats" class="btn-brutal" style="border-color: #555; color: #aaa;">LOAD ALL SATELLITES</button>

            <button id="btn-load-json-sats" class="btn-brutal" style="border-color: #00ffff; color: #00ffff;">LOAD ACTIVE SATELLITES</button>

            <div id="model-status" class="alert-status">FILE "ISS_stationary.glb" NOT FOUND.</div>

            <div class="footer">SRC: WHERETHEISS & CELESTRAK</div>
        </div>

        <div id="help-text-3d">DRAG TO ROTATE // SCROLL TO ZOOM</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let currentLat = 0, currentLon = 0;

        /* ==========================================
           1. LOGICA 2D LEAFLET
           ========================================== */
        const map = L.map('map', { zoomControl: false, attributionControl: true }).setView([0, 0], 5);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 10, className: 'map-base-layer' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 10, className: 'map-label-layer' }).addTo(map);

        // Forza singola mappa e previene la duplicazione del mondo
        const southWest = L.latLng(-90, -180);
        const northEast = L.latLng(90, 180);
        const mapBounds = L.latLngBounds(southWest, northEast);
        map.setMaxBounds(mapBounds);
        
        // Calcolo dinamico dello zoom minimo in base all'altezza dello schermo
        function updateMinZoom() {
            const minZoom = map.getBoundsZoom(mapBounds, true);
            map.setMinZoom(minZoom);
        }
        updateMinZoom(); 
        map.on('resize', updateMinZoom); 

        // Applica l'opzione "noWrap" ai layer nativi appena creati
        map.eachLayer(layer => {
            if (layer instanceof L.TileLayer) {
                layer.options.noWrap = true;
            }
        });

        const canvasRenderer = L.canvas({ padding: 0.5 });
        const allSatsLayerGroup = L.layerGroup().addTo(map);

        const issDivIcon = L.divIcon({ className: 'iss-marker-custom', iconSize: [20, 20], html: '<div class="iss-marker-shape"></div><div class="iss-label-2d">ISS</div>', iconAnchor: [10, 10] });
        let marker2D = L.marker([0, 0], {icon: issDivIcon, zIndexOffset: 1000}).addTo(map);
        let pathCoordinates = [];
        let pathLine = L.polyline(pathCoordinates, { color: '#ffffff', weight: 2 }).addTo(map);
        let firstLoad = true;

        /* ==========================================
           2. LOGICA 3D - SPACE EDITION
           ========================================== */
        const globeContainer = document.getElementById('globe-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); 
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambientLight);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.z = 35;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        globeContainer.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 2; controls.maxDistance = 150;

        function addStars() {
            const starGeo = new THREE.BufferGeometry();
            const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
            const starVerts = [];
            for (let i = 0; i < 10000; i++) {
                starVerts.push((Math.random()-0.5)*1500, (Math.random()-0.5)*1500, (Math.random()-0.5)*1500);
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starVerts, 3));
            scene.add(new THREE.Points(starGeo, starMat));
        }
        addStars();

        const earthRadius = 5;
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const landMesh = new THREE.Mesh(new THREE.SphereGeometry(earthRadius, 64, 64), new THREE.MeshBasicMaterial({ color: 0x000000 }));
        earthGroup.add(landMesh);

        const alphaTexture = new THREE.TextureLoader().load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/textures/planets/earth_specular_2048.jpg');
        const waterMesh = new THREE.Mesh(new THREE.SphereGeometry(earthRadius + 0.01, 64, 64), new THREE.MeshBasicMaterial({ color: 0x222222, alphaMap: alphaTexture, transparent: true, depthWrite: false }));
        earthGroup.add(waterMesh);

        const issRadius = earthRadius + (420 / 6371) * earthRadius; 
        const issPivot = new THREE.Group();
        earthGroup.add(issPivot);

        function createISSSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = "bold 60px monospace"; ctx.fillStyle = "#ffffff";
            ctx.textAlign = "left"; ctx.textBaseline = "middle"; ctx.fillText("ISS", 10, 64);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true, depthWrite: false }));
            sprite.scale.set(0.8, 0.4, 1); sprite.center.set(-0.2, 0.5); sprite.position.set(0, 0, 0); 
            return sprite;
        }
        issPivot.add(createISSSprite());

        new THREE.GLTFLoader().load('ISS_stationary.glb', function (gltf) {
            const model = gltf.scene; model.scale.set(0.005, 0.005, 0.005); 
            model.traverse(c => { if (c.isMesh) c.material = new THREE.MeshBasicMaterial({ color: 0xffffff }); });
            issPivot.add(model);
        }, undefined, function (e) {
            document.getElementById('model-status').style.display = 'block';
            const fb = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 0.15, 8), new THREE.MeshBasicMaterial({ color: 0xffffff }));
            fb.rotation.z = Math.PI / 2; issPivot.add(fb);
        });

        function latLongToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            return new THREE.Vector3(-(radius * Math.sin(phi) * Math.cos(theta)), (radius * Math.cos(phi)), (radius * Math.sin(phi) * Math.sin(theta)));
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            controls.update();
            if (issPivot.children.length > 0) issPivot.lookAt(new THREE.Vector3(0,0,0));
            renderer.render(scene, camera);
        }
        animate3D();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });

        /* ==========================================
           3. MOTORE FLOTTA SATELLITI
           ========================================== */
        let satsLoaded = false;
        let satsVisible = false; 
        let activeSatsData = []; 
        let satMarkers2D = [];   
        let fleetPoints3D = null;
        let fleetPositions3D = new Float32Array(0);

        // IL VECCHIO CODICE RIMANE INTONSO MA NON È PIÙ ACCESSIBILE TRAMITE UI
        document.getElementById('btn-load-sats').addEventListener('click', async function() {
            if(satsLoaded) return;
            const btn = this;
            btn.textContent = "INITIALIZING RADAR...";
            btn.style.color = "#ffffff";
            
            try {
                const res = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle');
                const text = await res.text();
                const lines = text.split('\n').map(l => l.trim());
                
                for(let i=0; i<lines.length; i+=3) {
                    if(lines[i] && lines[i+1] && lines[i+2]) {
                        const satrec = satellite.twoline2satrec(lines[i+1], lines[i+2]);
                        activeSatsData.push(satrec);
                        
                        const marker = L.circleMarker([0,0], {
                            renderer: canvasRenderer, radius: 1, color: '#444444', weight: 1, fillOpacity: 0.8
                        });
                        satMarkers2D.push(marker);
                        marker.addTo(allSatsLayerGroup);
                    }
                }

                const fleetGeo = new THREE.BufferGeometry();
                fleetPositions3D = new Float32Array(activeSatsData.length * 3);
                fleetGeo.setAttribute('position', new THREE.BufferAttribute(fleetPositions3D, 3));
                
                const fleetMat = new THREE.PointsMaterial({ color: 0x555555, size: 0.05 });
                fleetPoints3D = new THREE.Points(fleetGeo, fleetMat);
                earthGroup.add(fleetPoints3D);

                satsLoaded = true;
                btn.textContent = "FLEET ACTIVE (" + activeSatsData.length + ")";
                btn.style.borderColor = "#00ff00";
                btn.style.color = "#00ff00";

                updateFleetPositions();

            } catch (error) {
                console.error(error);
                btn.textContent = "CELESTRAK ERROR";
                btn.style.color = "#ff5555";
                btn.style.borderColor = "#ff5555";
            }
        });

        /* ==========================================
           MOTORE JSON SATELLITI ATTIVI OMM->TLE FIXATO CON TOGGLE E TESTO COERENTE
           ========================================== */
        document.getElementById('btn-load-json-sats').addEventListener('click', async function() {
            const btn = this;

            // Se i dati sono già caricati, attiviamo o disattiviamo visivamente
            if(satsLoaded) {
                satsVisible = !satsVisible;
                if(satsVisible) {
                    map.addLayer(allSatsLayerGroup);
                    if(fleetPoints3D) fleetPoints3D.visible = true;
                    
                    btn.textContent = "HIDE ACTIVE SATS";
                    btn.textContent = "HIDE ACTIVE SATELLITES"; 
                    btn.style.borderColor = "#555";
                    btn.style.color = "#aaa";
                } else {
                    map.removeLayer(allSatsLayerGroup);
                    if(fleetPoints3D) fleetPoints3D.visible = false;
                    
                    btn.textContent = "SHOW ACTIVE SATS";
                    btn.textContent = "SHOW ACTIVE SATELLITES"; 
                    btn.style.borderColor = "#00ffff";
                    btn.style.color = "#00ffff";
                }
                return;
            }

            btn.textContent = "SCANNING ACTIVE SATS...";
            btn.textContent = "SCANNING ACTIVE SATELLITES..."; 
            btn.style.color = "#ffffff";
            
            try {
                const res = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=json');
                const data = await res.json();
                
                const padL = (str, len, char = ' ') => str.toString().padStart(len, char);
                const padR = (str, len, char = ' ') => str.toString().padEnd(len, char);

                function ommToTle(omm) {
                    const catId = padL(omm.NORAD_CAT_ID, 5, '0');
                    const classification = omm.CLASSIFICATION_TYPE || 'U';
                    
                    let intDesignator = (omm.OBJECT_ID || '').replace('-', '');
                    if (intDesignator.length > 4 && (intDesignator.substring(0,2) === "19" || intDesignator.substring(0,2) === "20")) {
                        intDesignator = intDesignator.substring(2);
                    }
                    intDesignator = padR(intDesignator, 8, ' ');
                    
                    let epochStrRaw = omm.EPOCH || new Date().toISOString();
                    if (!epochStrRaw.endsWith('Z')) epochStrRaw += 'Z'; 
                    const epochDate = new Date(epochStrRaw);
                    
                    const yearStr = epochDate.getUTCFullYear().toString().slice(-2);
                    const startOfYear = new Date(Date.UTC(epochDate.getUTCFullYear(), 0, 0));
                    const dayOfYear = ((epochDate - startOfYear) / 86400000);
                    const epochDayStr = padL(dayOfYear.toFixed(8), 12, '0');
                    
                    const line1 = `1 ${catId}${classification} ${intDesignator} ${yearStr}${epochDayStr}  .00000000  00000-0  00000-0 0  9990`;
                    
                    const inc = padL((omm.INCLINATION || 0).toFixed(4), 8, ' ');
                    const raan = padL((omm.RA_OF_ASC_NODE || 0).toFixed(4), 8, ' ');
                    const ecc = padL(Math.round((omm.ECCENTRICITY || 0) * 1e7).toString(), 7, '0');
                    const aop = padL((omm.ARG_OF_PERICENTER || 0).toFixed(4), 8, ' ');
                    const ma = padL((omm.MEAN_ANOMALY || 0).toFixed(4), 8, ' ');
                    const mm = padL((omm.MEAN_MOTION || 0).toFixed(8), 11, ' ');
                    const rev = padL((omm.REV_AT_EPOCH || 0).toString().slice(0, 5), 5, '0');
                    
                    const line2 = `2 ${catId} ${inc} ${raan} ${ecc} ${aop} ${ma} ${mm}${rev}0`;
                    
                    return [line1, line2];
                }

                // Sostituzione cerchi con quadrati JSON
                const satSquareIcon = L.divIcon({
                    className: 'sat-marker-square',
                    iconSize: [3, 3], // Stessa dimensione visiva dei quadratini 3D per realismo
                    iconAnchor: [1.5, 1.5]
                });

                data.forEach(satData => {
                    if(satData.NORAD_CAT_ID && satData.MEAN_MOTION) {
                        const [tle1, tle2] = ommToTle(satData); 
                        const satrec = satellite.twoline2satrec(tle1, tle2);
                        activeSatsData.push(satrec);
                        
                        // L'icona è ora basata su divIcon invece che circleMarker
                        const marker = L.marker([0,0], { icon: satSquareIcon });
                        satMarkers2D.push(marker);
                        marker.addTo(allSatsLayerGroup);
                    }
                });

                const fleetGeo = new THREE.BufferGeometry();
                fleetPositions3D = new Float32Array(activeSatsData.length * 3);
                fleetGeo.setAttribute('position', new THREE.BufferAttribute(fleetPositions3D, 3));
                
                const fleetMat = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.05 });
                fleetPoints3D = new THREE.Points(fleetGeo, fleetMat);
                earthGroup.add(fleetPoints3D);

                satsLoaded = true;
                satsVisible = true; 
                
                btn.textContent = "HIDE ACTIVE SATS";
                btn.textContent = "HIDE ACTIVE SATELLITES"; 
                btn.style.borderColor = "#555";
                btn.style.color = "#aaa";

                updateFleetPositions();

            } catch (error) {
                console.error(error);
                btn.textContent = "JSON API ERROR";
                btn.style.color = "#ff5555";
                btn.style.borderColor = "#ff5555";
            }
        });

        function updateFleetPositions() {
            if(!satsLoaded || !satsVisible) return; 
            
            const now = new Date();
            const gmst = satellite.gstime(now); 
            
            let idx3D = 0;

            activeSatsData.forEach((satrec, i) => {
                const posAndVel = satellite.propagate(satrec, now);
                const posEci = posAndVel.position;

                if (posEci) {
                    const gd = satellite.eciToGeodetic(posEci, gmst);
                    const lat = satellite.degreesLat(gd.latitude);
                    const lon = satellite.degreesLong(gd.longitude);
                    const altKm = gd.height; 

                    satMarkers2D[i].setLatLng([lat, lon]);

                    const trueRadius3D = earthRadius + (altKm / 6371) * earthRadius;
                    const v3 = latLongToVector3(lat, lon, trueRadius3D);
                    
                    fleetPositions3D[idx3D++] = v3.x;
                    fleetPositions3D[idx3D++] = v3.y;
                    fleetPositions3D[idx3D++] = v3.z;
                } else {
                    idx3D += 3; 
                }
            });

            if(fleetPoints3D) fleetPoints3D.geometry.attributes.position.needsUpdate = true;
        }

        /* ==========================================
           4. TOGGLE & FOCUS
           ========================================== */
        let is3D = false; 
        
        const btnToggle = document.getElementById('btn-3d-toggle');
        btnToggle.addEventListener('click', () => {
            is3D = !is3D;
            if (is3D) {
                document.getElementById('map-container').style.display = 'none';
                globeContainer.style.display = 'block';
                document.getElementById('help-text-3d').style.display = 'block';
                btnToggle.textContent = 'RETURN TO 2D';
                if (issPivot.position.length() > 0) {
                    controls.target.copy(issPivot.position);
                    camera.position.copy(issPivot.position).add(issPivot.position.clone().normalize().multiplyScalar(15));
                }
            } else {
                document.getElementById('map-container').style.display = 'block';
                globeContainer.style.display = 'none';
                document.getElementById('help-text-3d').style.display = 'none';
                btnToggle.textContent = 'ENABLE 3D MODE';
                if (currentLat !== 0) map.setView([currentLat, currentLon], map.getZoom());
                
                updateMinZoom(); 
            }
        });

        /* ==========================================
           5. API ENGINE ISS (ORA IN HTTPS PER GITHUB)
           ========================================== */
        async function fetchISSLocation() {
            try {
                // Sostituito l'indirizzo HTTP con un'API sicura HTTPS
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    currentLat = parseFloat(data.latitude);
                    currentLon = parseFloat(data.longitude);
                    
                    document.getElementById('lat').textContent = currentLat.toFixed(4);
                    document.getElementById('lon').textContent = currentLon.toFixed(4);
                    document.getElementById('time').textContent = new Date(data.timestamp * 1000).toLocaleTimeString('en-GB', { hour12: false });
                    
                    marker2D.setLatLng([currentLat, currentLon]);
                    pathCoordinates.push([currentLat, currentLon]);
                    pathLine.setLatLngs(pathCoordinates);
                    if (firstLoad) { map.setView([currentLat, currentLon], updateMinZoom() || map.getZoom()); firstLoad = false; }
                    
                    const pos3D = latLongToVector3(currentLat, currentLon, issRadius);
                    issPivot.position.copy(pos3D);
                    if (is3D) { controls.target.copy(issPivot.position); }

                    updateFleetPositions();
                }
            } catch (e) { 
                console.error(e); 
            }
        }
        fetchISSLocation();
        setInterval(fetchISSLocation, 3000);
    </script>
</body>
</html>